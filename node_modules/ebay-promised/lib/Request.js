"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

// Definitions


var _objectToXml = require("object-to-xml");

var _objectToXml2 = _interopRequireDefault(_objectToXml);

var _bluebird = require("bluebird");

var _bluebird2 = _interopRequireDefault(_bluebird);

var _requestPromise = require("request-promise");

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _debug = require("debug");

var _debug2 = _interopRequireDefault(_debug);

var _simpleRateLimiter = require("simple-rate-limiter");

var _simpleRateLimiter2 = _interopRequireDefault(_simpleRateLimiter);

var _errors = require("./errors");

var _Parser = require("./Parser");

var _Parser2 = _interopRequireDefault(_Parser);

var _range = require("./utils/range");

var _range2 = _interopRequireDefault(_range);

var _Immutable = require("./utils/Immutable");

var _Immutable2 = _interopRequireDefault(_Immutable);

var _fields = require("./definitions/fields");

var _fields2 = _interopRequireDefault(_fields);

var _endpoints = require("./definitions/endpoints");

var _endpoints2 = _interopRequireDefault(_endpoints);

var _verbs = require("./definitions/verbs");

var _verbs2 = _interopRequireDefault(_verbs);

var _globals = require("./definitions/globals");

var _globals2 = _interopRequireDefault(_globals);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var SANDBOX = "sandbox";
var second = 1000;
var minute = 60 * second;
var hour = 60 * minute;
var day = 24 * hour;
var PROD = "production";
var HEADING = 'xml version="1.0" encoding="utf-8"?';
var LIST = "List";
var LISTING = "Listing";
var log = (0, _debug2.default)("ebay:request");
/**
 * Immmutable request object for making eBay API verbs
 */

var Request = function () {
  _createClass(Request, null, [{
    key: "create",


    /**
     * pure creation interface.  
     * Generally not needed as the Ebay module delegates transparently to a Request instance
     *
     * @param      {Object}   state   The state
     * @return     {Request}  the new Request object
     * @example
     * 
     *   Ebay
     *    .create(config)
     *    .GetMyeBaySelling()
     *    .run()
     *    .then(handleSuccess)
     *    .catch(errors.Ebay_Api_Error, handleValidationError)
     *    .catch(handleAllOtherErrors)
     */
    value: function create(state) {
      return new Request(state);
    }

    /**
     * creates the new Request object
     *
     * @private
     * @param      {Object}  previous  The previous state
     */

  }]);

  function Request() {
    var previous = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, Request);

    /**
     * internal immutable state
     */
    this.state = _Immutable2.default.copy(previous);
    /**
     * ensures fields are detectable
     */
    this.state.fields = this.state.fields || {};
    /**
     * ensures globals are detectable
     */
    this.state.globals = this.state.globals || {};

    /**
     * generates the headers for a request
     */
    this.headers = {
      "X-EBAY-API-CALL-NAME": this.verb,
      "X-EBAY-API-COMPATIBILITY-LEVEL": "775",
      "X-EBAY-API-CERT-NAME": this.globals.cert,
      "X-EBAY-API-SITEID": this.globals.site || 0,
      "X-EBAY-API-APP-NAME": this.globals.app || "node.js::ebay-promised"
    };
    Object.freeze(this.state);
    Object.freeze(this.headers);
  }

  /**
   * returns the URL of the Request
   *
   * @private
   * @return     {String}  the url
   */


  _createClass(Request, [{
    key: "xml",


    /**
     * returns the XML document for the request
     * 
     * @private
     * @param      {Object}  options  The options
     * @return     {String}           The XML string of the Request
     */
    value: function xml() {
      var _o2x;

      var options = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];


      var payload = this.fields;
      var listKey = this.listKey();

      if (listKey !== false) {
        payload[listKey] = _Immutable2.default.merge(payload[listKey], this.pagination(options.page));
      }

      return (0, _objectToXml2.default)((_o2x = {}, _defineProperty(_o2x, HEADING, null), _defineProperty(_o2x, this.xmlns, _Immutable2.default.merge(this.credentials, payload)), _o2x));
    }

    /**
     * convenience method for `tapping` the Request
     *
     * @param      {Function}  fn      The function to run
     */

  }, {
    key: "tap",
    value: function tap(fn) {
      fn.call(this, this);
      return this;
    }

    /**
     * determines if the Request uses a List and which key it is
     *
     * @private
     * @return     {string|false}   the key that is a List  
     */

  }, {
    key: "listKey",
    value: function listKey() {
      var fields = this.fieldKeys;
      while (fields.length) {
        var field = fields.pop();
        if (~field.indexOf(LISTING)) continue;
        if (~field.indexOf(LIST)) return field;
      }
      return false;
    }

    /**
     * generates a pagination Object
     *
     * @param      {number}  page    The page to fetch
     * @return     {Object}          The pagination representation
     */

  }, {
    key: "pagination",
    value: function pagination() {
      var page = arguments.length <= 0 || arguments[0] === undefined ? 1 : arguments[0];

      return {
        Pagination: {
          PageNumber: page,
          EntriesPerPage: this.globals.perPage
        }
      };
    }

    /**
     * alias for `run()`
     *
     * @deprecated
     * @return     {Promise<Object>}   resolves to the response 
     */

  }, {
    key: "invoke",
    value: function invoke() {
      console.warn("deprecation warning :: the .invoke() method has been migrated to .run() and will be removed in the next major release");
      return this.run();
    }

    /**
     * runs the HTTP Post to eBay
     *
     * @private
     * @param      {Object}   options  The options
     * @return     {Promise}           resolves to the response
     *
     */

  }, {
    key: "fetch",
    value: function fetch(options) {
      var _this = this;

      return new _bluebird2.default(function (resolve, reject) {
        Request.post({
          url: _this.endpoint,
          headers: _this.headers,
          body: _this.xml(options)
          // Hotfix for OpenSSL issue
          // https://github.com/openssl/openssl/pull/852
          // https://github.com/nodejs/node/issues/3692
          , agentOptions: {
            ciphers: 'ALL',
            secureProtocol: 'TLSv1_method'
          }
        }).once("limiter-exec", function (req) {
          req = _bluebird2.default.resolve(req).tap(log);

          // resolve to raw XML
          if (_this.globals.raw) {
            return req.then(resolve).catch(reject);
          }

          return req.then(_Parser2.default.toJSON).then(function (json) {
            return _Parser2.default.unwrap(_this, json);
          }).then(_Parser2.default.clean).then(resolve).catch(reject);
        });
      });
    }

    /**
     * runs the current Request 
     *
     * @param      {<type>}  options  The options
     * @return     {<type>}  { description_of_the_return_value }
     */

  }, {
    key: "run",
    value: function run() {
      var options = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

      if (!this.globals.authToken) _errors.throws.No_Auth_Token_Error();
      if (!this.verb) _errors.throws.No_Call_Error();

      return this.fetch(options).bind(this).then(this.schedule);
    }

    /**
     * schedules pagination requests
     * 
     * @private
     * @param      {Object}   first   The first response from the API
     * @return     {Promise}          resolves to the first resposne or the concatenated Responses
     */

  }, {
    key: "schedule",
    value: function schedule(first) {
      var _this2 = this;

      // we aren't handling pagination
      if (!first.pagination || first.pagination.pages < 2) return first;

      log("beginning pagination for [2.." + first.pagination.pages + "]");

      return _bluebird2.default.mapSeries((0, _range2.default)(2, first.pagination.pages), function (page) {
        return _this2.fetch({ page: page });
      }).then(function (results) {
        return results.reduce(function (all, result) {
          all.results = all.results.concat(result.results);
          return all;
        }, first);
      });
    }
  }, {
    key: "endpoint",
    get: function get() {
      var endpoint = _endpoints2.default[this.globals.serviceName][this.globals.sandbox ? SANDBOX : PROD];

      return endpoint ? endpoint : _errors.throws.Invalid_Endpoint(this);
    }

    /**
     * returns a copy of the internal globals
     *
     * @private
     * @return     {Object}  the globals
     */

  }, {
    key: "globals",
    get: function get() {
      return _Immutable2.default.copy(this.state.globals);
    }

    /**
     * returns an array of all the field names that have been added to the Request
     *
     * @private
     * @return     {Array<String>}  the array of names
     */

  }, {
    key: "fieldKeys",
    get: function get() {
      return Object.keys(this.fields);
    }

    /**
     * returns a copy of the Request's fields
     *
     * @private
     * @return     {Object}  the fields
     */

  }, {
    key: "fields",
    get: function get() {
      return _Immutable2.default.copy(this.state.fields);
    }

    /**
     * returns the expected name of XML node of a Request
     *
     * @private
     * @return     {String}  { description_of_the_return_value }
     */

  }, {
    key: "responseWrapper",
    get: function get() {
      return this.verb + "Response";
    }

    /**
     * returns the verb to use for this request
     *
     * @private
     * @return     {String}  the verb
     */

  }, {
    key: "verb",
    get: function get() {
      return this.state.verb;
    }

    /**
     * returns the auth token for this request
     * 
     * @private
     * @return     {String}  eBay Auth token
     */

  }, {
    key: "token",
    get: function get() {
      return this.globals.authToken;
    }

    /**
     * returns the XML structure for the SOAP auth
     * 
     * @private
     * @return     {Object}  the SOAP
     */

  }, {
    key: "credentials",
    get: function get() {
      return { RequesterCredentials: { eBayAuthToken: this.token } };
    }

    /**
     * returns the XML namespace
     * 
     * @private
     * @return     {String}  the XML namespace from the verb
     */

  }, {
    key: "xmlns",
    get: function get() {
      return this.verb + "Request xmlns=\"urn:ebay:apis:eBLBaseComponents\"";
    }
  }]);

  return Request;
}();

/**
 * 
 * Ebay ratelimits to 5000 verbs per day per default
 * 
 * source: https://go.developer.ebay.com/api-verb-limits
 * 
 * this can be reconfigured on load if you are using 
 * an approved compatible Application
 * 
 * @example
 *   Request.post.to(1.5million).per(DAY)
 * 
 */

exports.default = Request;
Request.RATELIMIT = {
  factor: 5000 / day * second // req/sec
};

Request.post = (0, _simpleRateLimiter2.default)(function EbayRequestSingleton() {
  return _requestPromise2.default.post.apply(_requestPromise2.default, arguments);
}).to(Math.floor(Request.RATELIMIT.factor * minute)).per(minute);

_verbs2.default.forEach(function (verb) {
  // cache
  var $verb = { verb: verb };

  Request.prototype[verb] = function requestCallSetter() {
    var cloned = _Immutable2.default.merge(this.state, $verb);
    return Request.create(cloned);
  };
});

_fields2.default.forEach(function (field) {
  Request.prototype[field] = function requestFieldSetter(val) {
    var cloned = _Immutable2.default.copy(this.state);
    cloned.fields[field] = val;
    return Request.create(cloned);
  };
});

Object.keys(_endpoints2.default).concat(_globals2.default).forEach(function (global) {
  Request.prototype[global] = function requestGlobalSetter(val) {
    _errors.throws.Setting_Error(global);
  };
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9SZXF1ZXN0LmpzIl0sIm5hbWVzIjpbIlNBTkRCT1giLCJzZWNvbmQiLCJtaW51dGUiLCJob3VyIiwiZGF5IiwiUFJPRCIsIkhFQURJTkciLCJMSVNUIiwiTElTVElORyIsImxvZyIsIlJlcXVlc3QiLCJzdGF0ZSIsInByZXZpb3VzIiwiY29weSIsImZpZWxkcyIsImdsb2JhbHMiLCJoZWFkZXJzIiwidmVyYiIsImNlcnQiLCJzaXRlIiwiYXBwIiwiT2JqZWN0IiwiZnJlZXplIiwib3B0aW9ucyIsInBheWxvYWQiLCJsaXN0S2V5IiwibWVyZ2UiLCJwYWdpbmF0aW9uIiwicGFnZSIsInhtbG5zIiwiY3JlZGVudGlhbHMiLCJmbiIsImNhbGwiLCJmaWVsZEtleXMiLCJsZW5ndGgiLCJmaWVsZCIsInBvcCIsImluZGV4T2YiLCJQYWdpbmF0aW9uIiwiUGFnZU51bWJlciIsIkVudHJpZXNQZXJQYWdlIiwicGVyUGFnZSIsImNvbnNvbGUiLCJ3YXJuIiwicnVuIiwicmVzb2x2ZSIsInJlamVjdCIsInBvc3QiLCJ1cmwiLCJlbmRwb2ludCIsImJvZHkiLCJ4bWwiLCJhZ2VudE9wdGlvbnMiLCJjaXBoZXJzIiwic2VjdXJlUHJvdG9jb2wiLCJvbmNlIiwicmVxIiwidGFwIiwicmF3IiwidGhlbiIsImNhdGNoIiwidG9KU09OIiwidW53cmFwIiwianNvbiIsImNsZWFuIiwiYXV0aFRva2VuIiwiTm9fQXV0aF9Ub2tlbl9FcnJvciIsIk5vX0NhbGxfRXJyb3IiLCJmZXRjaCIsImJpbmQiLCJzY2hlZHVsZSIsImZpcnN0IiwicGFnZXMiLCJtYXBTZXJpZXMiLCJyZXN1bHRzIiwicmVkdWNlIiwiYWxsIiwicmVzdWx0IiwiY29uY2F0Iiwic2VydmljZU5hbWUiLCJzYW5kYm94IiwiSW52YWxpZF9FbmRwb2ludCIsImtleXMiLCJSZXF1ZXN0ZXJDcmVkZW50aWFscyIsImVCYXlBdXRoVG9rZW4iLCJ0b2tlbiIsIlJBVEVMSU1JVCIsImZhY3RvciIsIkViYXlSZXF1ZXN0U2luZ2xldG9uIiwiYXJndW1lbnRzIiwidG8iLCJNYXRoIiwiZmxvb3IiLCJwZXIiLCJmb3JFYWNoIiwiJHZlcmIiLCJwcm90b3R5cGUiLCJyZXF1ZXN0Q2FsbFNldHRlciIsImNsb25lZCIsImNyZWF0ZSIsInJlcXVlc3RGaWVsZFNldHRlciIsInZhbCIsImdsb2JhbCIsInJlcXVlc3RHbG9iYWxTZXR0ZXIiLCJTZXR0aW5nX0Vycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQVdBOzs7QUFYQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBR0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7Ozs7Ozs7QUFFQSxJQUFNQSxVQUFVLFNBQWhCO0FBQ0EsSUFBTUMsU0FBVSxJQUFoQjtBQUNBLElBQU1DLFNBQVUsS0FBS0QsTUFBckI7QUFDQSxJQUFNRSxPQUFVLEtBQUtELE1BQXJCO0FBQ0EsSUFBTUUsTUFBVSxLQUFLRCxJQUFyQjtBQUNBLElBQU1FLE9BQVUsWUFBaEI7QUFDQSxJQUFNQyxVQUFVLHFDQUFoQjtBQUNBLElBQU1DLE9BQVUsTUFBaEI7QUFDQSxJQUFNQyxVQUFVLFNBQWhCO0FBQ0EsSUFBTUMsTUFBVSxxQkFBTSxjQUFOLENBQWhCO0FBQ0E7Ozs7SUFHcUJDLE87Ozs7O0FBRW5COzs7Ozs7Ozs7Ozs7Ozs7OzJCQWdCZUMsSyxFQUFPO0FBQ3BCLGFBQU8sSUFBSUQsT0FBSixDQUFZQyxLQUFaLENBQVA7QUFDRDs7QUFFRDs7Ozs7Ozs7O0FBTUEscUJBQThCO0FBQUEsUUFBaEJDLFFBQWdCLHlEQUFMLEVBQUs7O0FBQUE7O0FBQzVCOzs7QUFHQSxTQUFLRCxLQUFMLEdBQXNCLG9CQUFVRSxJQUFWLENBQWVELFFBQWYsQ0FBdEI7QUFDQTs7O0FBR0EsU0FBS0QsS0FBTCxDQUFXRyxNQUFYLEdBQXNCLEtBQUtILEtBQUwsQ0FBV0csTUFBWCxJQUFzQixFQUE1QztBQUNBOzs7QUFHQSxTQUFLSCxLQUFM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IiwiZmlsZSI6IlJlcXVlc3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbzJ4ICAgICAgICAgZnJvbSBcIm9iamVjdC10by14bWxcIlxuaW1wb3J0IFByb21pc2UgICAgIGZyb20gXCJibHVlYmlyZFwiXG5pbXBvcnQgcmVxICAgICAgICAgZnJvbSBcInJlcXVlc3QtcHJvbWlzZVwiXG5pbXBvcnQgZGVidWcgICAgICAgZnJvbSBcImRlYnVnXCJcbmltcG9ydCBsaW1pdCAgICAgICBmcm9tIFwic2ltcGxlLXJhdGUtbGltaXRlclwiXG5cbmltcG9ydCB7dGhyb3dzfSAgICBmcm9tIFwiLi9lcnJvcnNcIlxuaW1wb3J0IFBhcnNlciAgICAgIGZyb20gXCIuL1BhcnNlclwiXG5pbXBvcnQgcmFuZ2UgICAgICAgZnJvbSBcIi4vdXRpbHMvcmFuZ2VcIlxuaW1wb3J0IEltbXV0YWJsZSAgIGZyb20gXCIuL3V0aWxzL0ltbXV0YWJsZVwiXG5cbi8vIERlZmluaXRpb25zXG5pbXBvcnQgRmllbGRzICAgICAgZnJvbSBcIi4vZGVmaW5pdGlvbnMvZmllbGRzXCJcbmltcG9ydCBFbmRwb2ludHMgICBmcm9tIFwiLi9kZWZpbml0aW9ucy9lbmRwb2ludHNcIlxuaW1wb3J0IFZlcmJzICAgICAgIGZyb20gXCIuL2RlZmluaXRpb25zL3ZlcmJzXCJcbmltcG9ydCBHbG9iYWxzICAgICBmcm9tIFwiLi9kZWZpbml0aW9ucy9nbG9iYWxzXCJcblxuY29uc3QgU0FOREJPWCA9IFwic2FuZGJveFwiXG5jb25zdCBzZWNvbmQgID0gMTAwMFxuY29uc3QgbWludXRlICA9IDYwICogc2Vjb25kXG5jb25zdCBob3VyICAgID0gNjAgKiBtaW51dGVcbmNvbnN0IGRheSAgICAgPSAyNCAqIGhvdXJcbmNvbnN0IFBST0QgICAgPSBcInByb2R1Y3Rpb25cIlxuY29uc3QgSEVBRElORyA9ICd4bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwidXRmLThcIj8nXG5jb25zdCBMSVNUICAgID0gXCJMaXN0XCJcbmNvbnN0IExJU1RJTkcgPSBcIkxpc3RpbmdcIlxuY29uc3QgbG9nICAgICA9IGRlYnVnKFwiZWJheTpyZXF1ZXN0XCIpXG4vKipcbiAqIEltbW11dGFibGUgcmVxdWVzdCBvYmplY3QgZm9yIG1ha2luZyBlQmF5IEFQSSB2ZXJic1xuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZXF1ZXN0IHtcblxuICAvKipcbiAgICogcHVyZSBjcmVhdGlvbiBpbnRlcmZhY2UuICBcbiAgICogR2VuZXJhbGx5IG5vdCBuZWVkZWQgYXMgdGhlIEViYXkgbW9kdWxlIGRlbGVnYXRlcyB0cmFuc3BhcmVudGx5IHRvIGEgUmVxdWVzdCBpbnN0YW5jZVxuICAgKlxuICAgKiBAcGFyYW0gICAgICB7T2JqZWN0fSAgIHN0YXRlICAgVGhlIHN0YXRlXG4gICAqIEByZXR1cm4gICAgIHtSZXF1ZXN0fSAgdGhlIG5ldyBSZXF1ZXN0IG9iamVjdFxuICAgKiBAZXhhbXBsZVxuICAgKiBcbiAgICogICBFYmF5XG4gICAqICAgIC5jcmVhdGUoY29uZmlnKVxuICAgKiAgICAuR2V0TXllQmF5U2VsbGluZygpXG4gICAqICAgIC5ydW4oKVxuICAgKiAgICAudGhlbihoYW5kbGVTdWNjZXNzKVxuICAgKiAgICAuY2F0Y2goZXJyb3JzLkViYXlfQXBpX0Vycm9yLCBoYW5kbGVWYWxpZGF0aW9uRXJyb3IpXG4gICAqICAgIC5jYXRjaChoYW5kbGVBbGxPdGhlckVycm9ycylcbiAgICovXG4gIHN0YXRpYyBjcmVhdGUgKHN0YXRlKSB7XG4gICAgcmV0dXJuIG5ldyBSZXF1ZXN0KHN0YXRlKVxuICB9XG5cbiAgLyoqXG4gICAqIGNyZWF0ZXMgdGhlIG5ldyBSZXF1ZXN0IG9iamVjdFxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcGFyYW0gICAgICB7T2JqZWN0fSAgcHJldmlvdXMgIFRoZSBwcmV2aW91cyBzdGF0ZVxuICAgKi9cbiAgY29uc3RydWN0b3IgKCBwcmV2aW91cyA9IHt9ICkge1xuICAgIC8qKlxuICAgICAqIGludGVybmFsIGltbXV0YWJsZSBzdGF0ZVxuICAgICAqL1xuICAgIHRoaXMuc3RhdGUgICAgICAgICAgPSBJbW11dGFibGUuY29weShwcmV2aW91cylcbiAgICAvKipcbiAgICAgKiBlbnN1cmVzIGZpZWxkcyBhcmUgZGV0ZWN0YWJsZVxuICAgICAqL1xuICAgIHRoaXMuc3RhdGUuZmllbGRzICAgPSB0aGlzLnN0YXRlLmZpZWxkcyAgfHwge31cbiAgICAvKipcbiAgICAgKiBlbnN1cmVzIGdsb2JhbHMgYXJlIGRldGVjdGFibGVcbiAgICAgKi9cbiAgICB0aGlzLnN0YXRlLmdsb2JhbHMgID0gdGhpcy5zdGF0ZS5nbG9iYWxzIHx8IHt9XG5cbiAgICAvKipcbiAgICAgKiBnZW5lcmF0ZXMgdGhlIGhlYWRlcnMgZm9yIGEgcmVxdWVzdFxuICAgICAqL1xuICAgIHRoaXMuaGVhZGVycyA9IHtcbiAgICAgICAgXCJYLUVCQVktQVBJLUNBTEwtTkFNRVwiICAgICAgICAgICA6IHRoaXMudmVyYlxuICAgICAgLCBcIlgtRUJBWS1BUEktQ09NUEFUSUJJTElUWS1MRVZFTFwiIDogXCI3NzVcIlxuICAgICAgLCBcIlgtRUJBWS1BUEktQ0VSVC1OQU1FXCIgICAgICAgICAgIDogdGhpcy5nbG9iYWxzLmNlcnRcbiAgICAgICwgXCJYLUVCQVktQVBJLVNJVEVJRFwiICAgICAgICAgICAgICA6IHRoaXMuZ2xvYmFscy5zaXRlIHx8IDBcbiAgICAgICwgXCJYLUVCQVktQVBJLUFQUC1OQU1FXCIgICAgICAgICAgICA6IHRoaXMuZ2xvYmFscy5hcHAgIHx8IFwibm9kZS5qczo6ZWJheS1wcm9taXNlZFwiXG4gICAgfVxuICAgIE9iamVjdC5mcmVlemUodGhpcy5zdGF0ZSlcbiAgICBPYmplY3QuZnJlZXplKHRoaXMuaGVhZGVycylcblxuICB9XG5cbiAgLyoqXG4gICAqIHJldHVybnMgdGhlIFVSTCBvZiB0aGUgUmVxdWVzdFxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcmV0dXJuICAgICB7U3RyaW5nfSAgdGhlIHVybFxuICAgKi9cbiAgZ2V0IGVuZHBvaW50ICgpIHtcbiAgICBjb25zdCBlbmRwb2ludCA9IEVuZHBvaW50c1t0aGlzLmdsb2JhbHMuc2VydmljZU5hbWVdWyB0aGlzLmdsb2JhbHMuc2FuZGJveCA/IFNBTkRCT1ggOiBQUk9EIF1cbiAgICBcbiAgICByZXR1cm4gZW5kcG9pbnRcbiAgICAgID8gZW5kcG9pbnRcbiAgICAgIDogdGhyb3dzLkludmFsaWRfRW5kcG9pbnQodGhpcylcbiAgfVxuXG4gIC8qKlxuICAgKiByZXR1cm5zIGEgY29weSBvZiB0aGUgaW50ZXJuYWwgZ2xvYmFsc1xuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcmV0dXJuICAgICB7T2JqZWN0fSAgdGhlIGdsb2JhbHNcbiAgICovXG4gIGdldCBnbG9iYWxzICgpIHtcbiAgICByZXR1cm4gSW1tdXRhYmxlLmNvcHkodGhpcy5zdGF0ZS5nbG9iYWxzKVxuICB9XG5cbiAgLyoqXG4gICAqIHJldHVybnMgYW4gYXJyYXkgb2YgYWxsIHRoZSBmaWVsZCBuYW1lcyB0aGF0IGhhdmUgYmVlbiBhZGRlZCB0byB0aGUgUmVxdWVzdFxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcmV0dXJuICAgICB7QXJyYXk8U3RyaW5nPn0gIHRoZSBhcnJheSBvZiBuYW1lc1xuICAgKi9cbiAgZ2V0IGZpZWxkS2V5cyAoKSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuZmllbGRzKVxuICB9XG5cbiAgLyoqXG4gICAqIHJldHVybnMgYSBjb3B5IG9mIHRoZSBSZXF1ZXN0J3MgZmllbGRzXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEByZXR1cm4gICAgIHtPYmplY3R9ICB0aGUgZmllbGRzXG4gICAqL1xuICBnZXQgZmllbGRzICgpIHtcbiAgICByZXR1cm4gSW1tdXRhYmxlLmNvcHkodGhpcy5zdGF0ZS5maWVsZHMpXG4gIH1cblxuICAvKipcbiAgICogcmV0dXJucyB0aGUgZXhwZWN0ZWQgbmFtZSBvZiBYTUwgbm9kZSBvZiBhIFJlcXVlc3RcbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQHJldHVybiAgICAge1N0cmluZ30gIHsgZGVzY3JpcHRpb25fb2ZfdGhlX3JldHVybl92YWx1ZSB9XG4gICAqL1xuICBnZXQgcmVzcG9uc2VXcmFwcGVyICgpIHtcbiAgICByZXR1cm4gYCR7dGhpcy52ZXJifVJlc3BvbnNlYFxuICB9XG5cbiAgLyoqXG4gICAqIHJldHVybnMgdGhlIHZlcmIgdG8gdXNlIGZvciB0aGlzIHJlcXVlc3RcbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQHJldHVybiAgICAge1N0cmluZ30gIHRoZSB2ZXJiXG4gICAqL1xuICBnZXQgdmVyYiAoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUudmVyYlxuICB9XG5cbiAgLyoqXG4gICAqIHJldHVybnMgdGhlIGF1dGggdG9rZW4gZm9yIHRoaXMgcmVxdWVzdFxuICAgKiBcbiAgICogQHByaXZhdGVcbiAgICogQHJldHVybiAgICAge1N0cmluZ30gIGVCYXkgQXV0aCB0b2tlblxuICAgKi9cbiAgZ2V0IHRva2VuICgpIHtcbiAgICByZXR1cm4gdGhpcy5nbG9iYWxzLmF1dGhUb2tlblxuICB9XG5cbiAgLyoqXG4gICAqIHJldHVybnMgdGhlIFhNTCBzdHJ1Y3R1cmUgZm9yIHRoZSBTT0FQIGF1dGhcbiAgICogXG4gICAqIEBwcml2YXRlXG4gICAqIEByZXR1cm4gICAgIHtPYmplY3R9ICB0aGUgU09BUFxuICAgKi9cbiAgZ2V0IGNyZWRlbnRpYWxzICgpIHtcbiAgICByZXR1cm4geyBSZXF1ZXN0ZXJDcmVkZW50aWFsczogeyBlQmF5QXV0aFRva2VuOiB0aGlzLnRva2VuIH0gfVxuICB9XG5cbiAgLyoqXG4gICAqIHJldHVybnMgdGhlIFhNTCBuYW1lc3BhY2VcbiAgICogXG4gICAqIEBwcml2YXRlXG4gICAqIEByZXR1cm4gICAgIHtTdHJpbmd9ICB0aGUgWE1MIG5hbWVzcGFjZSBmcm9tIHRoZSB2ZXJiXG4gICAqL1xuICBnZXQgeG1sbnMgKCkge1xuICAgIHJldHVybiBgJHt0aGlzLnZlcmJ9UmVxdWVzdCB4bWxucz1cInVybjplYmF5OmFwaXM6ZUJMQmFzZUNvbXBvbmVudHNcImBcbiAgfVxuXG4gIC8qKlxuICAgKiByZXR1cm5zIHRoZSBYTUwgZG9jdW1lbnQgZm9yIHRoZSByZXF1ZXN0XG4gICAqIFxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcGFyYW0gICAgICB7T2JqZWN0fSAgb3B0aW9ucyAgVGhlIG9wdGlvbnNcbiAgICogQHJldHVybiAgICAge1N0cmluZ30gICAgICAgICAgIFRoZSBYTUwgc3RyaW5nIG9mIHRoZSBSZXF1ZXN0XG4gICAqL1xuICB4bWwgKG9wdGlvbnMgPSB7fSkge1xuXG4gICAgY29uc3QgcGF5bG9hZCAgPSB0aGlzLmZpZWxkc1xuICAgIGNvbnN0IGxpc3RLZXkgID0gdGhpcy5saXN0S2V5KClcblxuICAgIGlmIChsaXN0S2V5ICE9PSBmYWxzZSkge1xuICAgICAgcGF5bG9hZFsgbGlzdEtleSBdID0gSW1tdXRhYmxlLm1lcmdlKCBcbiAgICAgICAgICBwYXlsb2FkW2xpc3RLZXldXG4gICAgICAgICwgdGhpcy5wYWdpbmF0aW9uKG9wdGlvbnMucGFnZSkgXG4gICAgICApXG4gICAgfVxuXG4gICAgcmV0dXJuIG8yeCh7XG4gICAgICAgIFtIRUFESU5HXSAgICA6IG51bGxcbiAgICAgICwgW3RoaXMueG1sbnNdIDogSW1tdXRhYmxlLm1lcmdlKHRoaXMuY3JlZGVudGlhbHMsIHBheWxvYWQpXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBjb252ZW5pZW5jZSBtZXRob2QgZm9yIGB0YXBwaW5nYCB0aGUgUmVxdWVzdFxuICAgKlxuICAgKiBAcGFyYW0gICAgICB7RnVuY3Rpb259ICBmbiAgICAgIFRoZSBmdW5jdGlvbiB0byBydW5cbiAgICovXG4gIHRhcCAoZm4pIHtcbiAgICBmbi5jYWxsKHRoaXMsIHRoaXMpXG4gICAgcmV0dXJuIHRoaXNcbiAgfVxuXG4gIC8qKlxuICAgKiBkZXRlcm1pbmVzIGlmIHRoZSBSZXF1ZXN0IHVzZXMgYSBMaXN0IGFuZCB3aGljaCBrZXkgaXQgaXNcbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQHJldHVybiAgICAge3N0cmluZ3xmYWxzZX0gICB0aGUga2V5IHRoYXQgaXMgYSBMaXN0ICBcbiAgICovXG4gIGxpc3RLZXkgKCkge1xuICAgIGNvbnN0IGZpZWxkcyA9IHRoaXMuZmllbGRLZXlzXG4gICAgd2hpbGUgKGZpZWxkcy5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IGZpZWxkID0gZmllbGRzLnBvcCgpXG4gICAgICBpZiAofmZpZWxkLmluZGV4T2YoTElTVElORykpIGNvbnRpbnVlXG4gICAgICBpZiAofmZpZWxkLmluZGV4T2YoTElTVCkpIHJldHVybiBmaWVsZFxuICAgIH1cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuXG4gIC8qKlxuICAgKiBnZW5lcmF0ZXMgYSBwYWdpbmF0aW9uIE9iamVjdFxuICAgKlxuICAgKiBAcGFyYW0gICAgICB7bnVtYmVyfSAgcGFnZSAgICBUaGUgcGFnZSB0byBmZXRjaFxuICAgKiBAcmV0dXJuICAgICB7T2JqZWN0fSAgICAgICAgICBUaGUgcGFnaW5hdGlvbiByZXByZXNlbnRhdGlvblxuICAgKi9cbiAgcGFnaW5hdGlvbiAocGFnZT0xKSB7XG4gICAgcmV0dXJuIHsgIFxuICAgICAgUGFnaW5hdGlvbjoge1xuICAgICAgICAgIFBhZ2VOdW1iZXIgICAgIDogcGFnZVxuICAgICAgICAsIEVudHJpZXNQZXJQYWdlIDogdGhpcy5nbG9iYWxzLnBlclBhZ2VcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogYWxpYXMgZm9yIGBydW4oKWBcbiAgICpcbiAgICogQGRlcHJlY2F0ZWRcbiAgICogQHJldHVybiAgICAge1Byb21pc2U8T2JqZWN0Pn0gICByZXNvbHZlcyB0byB0aGUgcmVzcG9uc2UgXG4gICAqL1xuICBpbnZva2UgKCkge1xuICAgIGNvbnNvbGUud2FybihcImRlcHJlY2F0aW9uIHdhcm5pbmcgOjogdGhlIC5pbnZva2UoKSBtZXRob2QgaGFzIGJlZW4gbWlncmF0ZWQgdG8gLnJ1bigpIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZVwiKVxuICAgIHJldHVybiB0aGlzLnJ1bigpXG4gIH1cblxuICAvKipcbiAgICogcnVucyB0aGUgSFRUUCBQb3N0IHRvIGVCYXlcbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQHBhcmFtICAgICAge09iamVjdH0gICBvcHRpb25zICBUaGUgb3B0aW9uc1xuICAgKiBAcmV0dXJuICAgICB7UHJvbWlzZX0gICAgICAgICAgIHJlc29sdmVzIHRvIHRoZSByZXNwb25zZVxuICAgKlxuICAgKi9cbiAgZmV0Y2ggKG9wdGlvbnMpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoIChyZXNvbHZlLCByZWplY3QpPT4ge1xuICAgICAgUmVxdWVzdC5wb3N0KHtcbiAgICAgICAgICB1cmwgICAgICAgOiB0aGlzLmVuZHBvaW50XG4gICAgICAgICwgaGVhZGVycyAgIDogdGhpcy5oZWFkZXJzXG4gICAgICAgICwgYm9keSAgICAgIDogdGhpcy54bWwob3B0aW9ucylcbiAgICAgICAgLy8gSG90Zml4IGZvciBPcGVuU1NMIGlzc3VlXG4gICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9vcGVuc3NsL29wZW5zc2wvcHVsbC84NTJcbiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL25vZGVqcy9ub2RlL2lzc3Vlcy8zNjkyXG4gICAgICAgICwgYWdlbnRPcHRpb25zOiB7IFxuICAgICAgICAgICAgICBjaXBoZXJzICAgICAgICA6ICdBTEwnXG4gICAgICAgICAgICAsIHNlY3VyZVByb3RvY29sIDogJ1RMU3YxX21ldGhvZCdcbiAgICAgICAgICB9XG4gICAgICB9KS5vbmNlKFwibGltaXRlci1leGVjXCIsICByZXEgPT4ge1xuICAgICAgICByZXEgPSBQcm9taXNlXG4gICAgICAgICAgLnJlc29sdmUocmVxKVxuICAgICAgICAgIC50YXAobG9nKVxuXG4gICAgICAgIC8vIHJlc29sdmUgdG8gcmF3IFhNTFxuICAgICAgICBpZiAodGhpcy5nbG9iYWxzLnJhdykge1xuICAgICAgICAgIHJldHVybiByZXEudGhlbihyZXNvbHZlKS5jYXRjaChyZWplY3QpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVxXG4gICAgICAgICAgLnRoZW4oUGFyc2VyLnRvSlNPTilcbiAgICAgICAgICAudGhlbigganNvbiA9PiBQYXJzZXIudW53cmFwKHRoaXMsIGpzb24pIClcbiAgICAgICAgICAudGhlbihQYXJzZXIuY2xlYW4pXG4gICAgICAgICAgLnRoZW4ocmVzb2x2ZSlcbiAgICAgICAgICAuY2F0Y2gocmVqZWN0KVxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgLyoqXG4gICAqIHJ1bnMgdGhlIGN1cnJlbnQgUmVxdWVzdCBcbiAgICpcbiAgICogQHBhcmFtICAgICAgezx0eXBlPn0gIG9wdGlvbnMgIFRoZSBvcHRpb25zXG4gICAqIEByZXR1cm4gICAgIHs8dHlwZT59ICB7IGRlc2NyaXB0aW9uX29mX3RoZV9yZXR1cm5fdmFsdWUgfVxuICAgKi9cbiAgcnVuIChvcHRpb25zID0ge30pIHtcbiAgICBpZiAoICF0aGlzLmdsb2JhbHMuYXV0aFRva2VuICkgdGhyb3dzLk5vX0F1dGhfVG9rZW5fRXJyb3IoKVxuICAgIGlmICggIXRoaXMudmVyYiApICAgICAgICAgICAgICB0aHJvd3MuTm9fQ2FsbF9FcnJvcigpXG5cbiAgICByZXR1cm4gdGhpc1xuICAgICAgLmZldGNoKG9wdGlvbnMpXG4gICAgICAuYmluZCh0aGlzKVxuICAgICAgLnRoZW4odGhpcy5zY2hlZHVsZSlcbiAgfVxuXG4gIC8qKlxuICAgKiBzY2hlZHVsZXMgcGFnaW5hdGlvbiByZXF1ZXN0c1xuICAgKiBcbiAgICogQHByaXZhdGVcbiAgICogQHBhcmFtICAgICAge09iamVjdH0gICBmaXJzdCAgIFRoZSBmaXJzdCByZXNwb25zZSBmcm9tIHRoZSBBUElcbiAgICogQHJldHVybiAgICAge1Byb21pc2V9ICAgICAgICAgIHJlc29sdmVzIHRvIHRoZSBmaXJzdCByZXNwb3NuZSBvciB0aGUgY29uY2F0ZW5hdGVkIFJlc3BvbnNlc1xuICAgKi9cbiAgc2NoZWR1bGUgKGZpcnN0KSB7XG4gICAgLy8gd2UgYXJlbid0IGhhbmRsaW5nIHBhZ2luYXRpb25cbiAgICBpZiAoIWZpcnN0LnBhZ2luYXRpb24gfHwgZmlyc3QucGFnaW5hdGlvbi5wYWdlcyA8IDIpIHJldHVybiBmaXJzdFxuXG4gICAgbG9nKGBiZWdpbm5pbmcgcGFnaW5hdGlvbiBmb3IgWzIuLiR7Zmlyc3QucGFnaW5hdGlvbi5wYWdlc31dYClcbiAgICBcbiAgICByZXR1cm4gUHJvbWlzZS5tYXBTZXJpZXMoXG4gICAgICAgIHJhbmdlKDIsIGZpcnN0LnBhZ2luYXRpb24ucGFnZXMpXG4gICAgICAsIHBhZ2UgPT4gdGhpcy5mZXRjaCh7IHBhZ2U6IHBhZ2UgfSlcbiAgICApLnRoZW4oIHJlc3VsdHMgPT4ge1xuICAgICAgcmV0dXJuIHJlc3VsdHMucmVkdWNlKCAoYWxsLCByZXN1bHQpID0+IHtcbiAgICAgICAgYWxsLnJlc3VsdHMgPSBhbGwucmVzdWx0cy5jb25jYXQoIHJlc3VsdC5yZXN1bHRzIClcbiAgICAgICAgcmV0dXJuIGFsbFxuICAgICAgfSwgZmlyc3QpXG4gICAgfSlcbiAgfVxufVxuXG4vKipcbiAqIFxuICogRWJheSByYXRlbGltaXRzIHRvIDUwMDAgdmVyYnMgcGVyIGRheSBwZXIgZGVmYXVsdFxuICogXG4gKiBzb3VyY2U6IGh0dHBzOi8vZ28uZGV2ZWxvcGVyLmViYXkuY29tL2FwaS12ZXJiLWxpbWl0c1xuICogXG4gKiB0aGlzIGNhbiBiZSByZWNvbmZpZ3VyZWQgb24gbG9hZCBpZiB5b3UgYXJlIHVzaW5nIFxuICogYW4gYXBwcm92ZWQgY29tcGF0aWJsZSBBcHBsaWNhdGlvblxuICogXG4gKiBAZXhhbXBsZVxuICogICBSZXF1ZXN0LnBvc3QudG8oMS41bWlsbGlvbikucGVyKERBWSlcbiAqIFxuICovXG5cblJlcXVlc3QuUkFURUxJTUlUID0ge1xuICBmYWN0b3IgOiAoIDUwMDAgLyBkYXkgKSAqIHNlY29uZCAvLyByZXEvc2VjXG59XG5cblJlcXVlc3QucG9zdCA9IGxpbWl0KCBmdW5jdGlvbiBFYmF5UmVxdWVzdFNpbmdsZXRvbiAoKSB7IHJldHVybiByZXEucG9zdCguLi5hcmd1bWVudHMpIH0pXG4gIC50byggTWF0aC5mbG9vcihSZXF1ZXN0LlJBVEVMSU1JVC5mYWN0b3IgKiBtaW51dGUpIClcbiAgLnBlciggbWludXRlIClcblxuVmVyYnMuZm9yRWFjaCggdmVyYiA9PiB7XG4gIC8vIGNhY2hlXG4gIGNvbnN0ICR2ZXJiID0ge3ZlcmI6IHZlcmJ9XG4gIFxuICBSZXF1ZXN0LnByb3RvdHlwZVt2ZXJiXSA9IGZ1bmN0aW9uIHJlcXVlc3RDYWxsU2V0dGVyICgpIHtcbiAgICBjb25zdCBjbG9uZWQgPSBJbW11dGFibGUubWVyZ2UodGhpcy5zdGF0ZSwgJHZlcmIpXG4gICAgcmV0dXJuIFJlcXVlc3QuY3JlYXRlKGNsb25lZClcbiAgfVxufSlcblxuRmllbGRzLmZvckVhY2goIGZpZWxkID0+IHtcbiAgUmVxdWVzdC5wcm90b3R5cGVbZmllbGRdID0gZnVuY3Rpb24gcmVxdWVzdEZpZWxkU2V0dGVyICh2YWwpIHtcbiAgICBjb25zdCBjbG9uZWQgPSBJbW11dGFibGUuY29weSh0aGlzLnN0YXRlKVxuICAgIGNsb25lZC5maWVsZHNbZmllbGRdID0gdmFsXG4gICAgcmV0dXJuIFJlcXVlc3QuY3JlYXRlKGNsb25lZClcbiAgfVxufSlcblxuT2JqZWN0LmtleXMoRW5kcG9pbnRzKS5jb25jYXQoR2xvYmFscykuZm9yRWFjaCggZ2xvYmFsID0+IHtcbiAgUmVxdWVzdC5wcm90b3R5cGVbZ2xvYmFsXSA9IGZ1bmN0aW9uIHJlcXVlc3RHbG9iYWxTZXR0ZXIgKHZhbCkge1xuICAgIHRocm93cy5TZXR0aW5nX0Vycm9yKGdsb2JhbClcbiAgfVxufSlcbiJdfQ==